# Docker compose file for EDGAR test environment (deploys a cluster of EDGAR instances)
# Used by `cargo theo testenv edgar start`

services:

  leader:
    container_name: edgar-leader  # defined DNS for the container
    build:
      context: ../../../..
      dockerfile: ./.ci/deploy/testenv/edgar/Dockerfile
    command: /opt/managed.sh leader
    #command: sleep infinity
    volumes:
      - ../../../../target/ci/distribution/x86_64-unknown-linux-gnu/:/opt/artifacts
      - "../../../../target/debug/:/usr/local/opendut/bin/debug/"
      - opendut_provision-secrets-data:/provision:ro
    cap_add:
      - NET_ADMIN
    environment:
      # CLEO
      - OPENDUT_CLEO_NETWORK_CARL_HOST=carl.opendut.local
      - OPENDUT_CLEO_NETWORK_CARL_PORT=443
      - OPENDUT_CLEO_NETWORK_TLS_DOMAIN_NAME_OVERRIDE=carl.opendut.local  # default developer certificate is only valid for localhost
      - OPENDUT_CLEO_NETWORK_TLS_CA=/provision/pki/opendut-ca.pem
      - OPENDUT_CLEO_NETWORK_OIDC_ENABLED=true
      - OPENDUT_CLEO_NETWORK_OIDC_CLIENT_ID=opendut-cleo-client
      - OPENDUT_CLEO_NETWORK_OIDC_CLIENT_SECRET
      - OPENDUT_CLEO_NETWORK_OIDC_CLIENT_ISSUER_URL=https://auth.opendut.local/realms/opendut/
      - OPENDUT_CLEO_NETWORK_OIDC_CLIENT_SCOPES=

      # EDGAR
      - OPENDUT_EDGAR_NETWORK_CARL_HOST=carl.opendut.local
      - OPENDUT_EDGAR_NETWORK_CARL_PORT=443
      - OPENDUT_EDGAR_NETWORK_TLS_DOMAIN_NAME_OVERRIDE=carl.opendut.local  # default developer certificate is only valid for localhost
      - OPENDUT_EDGAR_NETWORK_TLS_CA=/provision/pki/opendut-ca.pem
      - OPENDUT_EDGAR_NETWORK_OIDC_ENABLED=true
      - OPENDUT_EDGAR_NETWORK_OIDC_CLIENT_ID=opendut-edgar-client
      - OPENDUT_EDGAR_NETWORK_OIDC_CLIENT_SECRET
      - OPENDUT_EDGAR_NETWORK_OIDC_CLIENT_ISSUER_URL=https://auth.opendut.local/realms/opendut/
      - OPENDUT_EDGAR_NETWORK_OIDC_CLIENT_SCOPES=
      - OPENDUT_EDGAR_OPENTELEMETRY_ENABLED=true
      - OPENDUT_EDGAR_OPENTELEMETRY_COLLECTOR_ENDPOINT=http://otel-collector:4317

      # testenv
      - OPENDUT_EDGAR_REPLICAS
      - OPENDUT_EDGAR_SERVICE_USER=root
      # Rust backtrace
      - RUST_BACKTRACE=1

    networks:
      - opendut_local
    privileged: true 

  peer:
    build:
      context: ../../../..
      dockerfile: ./.ci/deploy/testenv/edgar/Dockerfile
    command: /opt/managed.sh
    #command: sleep infinity
    volumes:
      - ../../../../target/ci/distribution/x86_64-unknown-linux-gnu/:/opt/artifacts:ro
      - "../../../../target/debug/:/usr/local/opendut/bin/debug/:ro"
      - opendut_provision-secrets-data:/provision:ro
    cap_add:
      - NET_ADMIN
    environment:
      # CLEO
      - OPENDUT_CLEO_NETWORK_CARL_HOST=carl.opendut.local
      - OPENDUT_CLEO_NETWORK_CARL_PORT=443
      - OPENDUT_CLEO_NETWORK_TLS_DOMAIN_NAME_OVERRIDE=carl.opendut.local  # default developer certificate is only valid for localhost
      - OPENDUT_CLEO_NETWORK_TLS_CA=/provision/pki/opendut-ca.pem
      - OPENDUT_CLEO_NETWORK_OIDC_ENABLED=true
      - OPENDUT_CLEO_NETWORK_OIDC_CLIENT_ID=opendut-cleo-client
      - OPENDUT_CLEO_NETWORK_OIDC_CLIENT_SECRET
      - OPENDUT_CLEO_NETWORK_OIDC_CLIENT_ISSUER_URL=https://auth.opendut.local/realms/opendut/
      - OPENDUT_CLEO_NETWORK_OIDC_CLIENT_SCOPES=

      # EDGAR
      - OPENDUT_EDGAR_NETWORK_CARL_HOST=carl.opendut.local
      - OPENDUT_EDGAR_NETWORK_CARL_PORT=443
      - OPENDUT_EDGAR_NETWORK_TLS_DOMAIN_NAME_OVERRIDE=carl.opendut.local  # default developer certificate is only valid for localhost
      - OPENDUT_EDGAR_NETWORK_TLS_CA=/provision/pki/opendut-ca.pem
      - OPENDUT_EDGAR_NETWORK_OIDC_ENABLED=true
      - OPENDUT_EDGAR_NETWORK_OIDC_CLIENT_ID=opendut-edgar-client
      - OPENDUT_EDGAR_NETWORK_OIDC_CLIENT_SECRET
      - OPENDUT_EDGAR_NETWORK_OIDC_CLIENT_ISSUER_URL=https://auth.opendut.local/realms/opendut/
      - OPENDUT_EDGAR_NETWORK_OIDC_CLIENT_SCOPES=
      - OPENDUT_EDGAR_OPENTELEMETRY_ENABLED=true
      - OPENDUT_EDGAR_OPENTELEMETRY_COLLECTOR_ENDPOINT=http://otel-collector:4317

      # testenv
      - OPENDUT_EDGAR_REPLICAS
      - OPENDUT_EDGAR_SERVICE_USER=root
      # Rust backtrace
      - RUST_BACKTRACE=1

    deploy:
      mode: replicated
      # edgar replica count (e.g. 3)
      replicas: ${OPENDUT_EDGAR_REPLICAS}
    networks:
      - opendut_local

volumes:
  opendut_provision-secrets-data:
    external: true

networks:
  opendut_local:
    name: opendut_local
    external: true  # Use a pre-existing network
